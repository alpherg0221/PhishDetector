import{a as I,b as v,h as m,L as d}from"../assets/utils.js";chrome.runtime.onMessage.addListener((e,s,t)=>{switch(e.type){case"detection":return f().then(o=>t(o)),!0}});const f=async e=>{const s=await I(),t=await v(),o=await m(d.Allow),a=await m(d.Block),n=await m(d.Tmp).then(u=>u.map(S=>S.split("@")[0]));if(t&&o.includes(location.hostname))return{resFlag:"Safe",classifierRes:"Safe",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};if(s&&a.includes(location.hostname))return{resFlag:"Phish",classifierRes:"Phish",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};if(n.includes(location.hostname))return{resFlag:"_Phish",classifierRes:"_Phish",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};const i=6,h=performance.now()/1e3;let r="Safe",c="Safe";await C()||(c="NoPasswordForm");const l=await F(),b=(performance.now()/1e3-h).toFixed(i),g=await q(),p=await P(),k=await H(),y=await R(),w=await W(),L=await O(),_=await B(),A=await E(),T=await N(),x=await U();if(c!=="NoPasswordForm"){const u={copied:l,googleAnalytics:g,scriptTagCount:p,externalLinkPercentage:k,noTitle:y,samePageLink:w,iframeTagCount:L,tagCountInHeadTag:_,noDomainInInternalLink:A,invalidKiyaku:T,ipAddressInLink:x};await chrome.runtime.sendMessage({type:"predict",features:u})>=.5?r="Phish":r="Safe",l||r=="Phish"?c="Phish":c="Safe"}return{resFlag:c,classifierRes:r,url:location.hostname,copiedTime:b,classifierTime:(performance.now()/1e3-h).toFixed(i),detectBy:"RealTime",copied:l,ga:g,script:p,extLink:k,noTitle:y,samePageLink:w,iframe:L,tagCountInHead:_,noDomainInInternalLink:A,invalidKiyaku:T,ipAddressInLink:x}},C=async()=>{let e=document.querySelectorAll('input[type="password"]').length,s=document.querySelectorAll('input[type="text"]').length;const t=document.querySelectorAll("iframe");for(const o of t)try{e+=o.contentWindow.document.querySelectorAll('input[type="password"]').length,s+=o.contentWindow.document.querySelectorAll('input[type="text"]').length}catch{}return e>=1||s>=5},$=async e=>{e.detectBy==="List"?location.assign(`${chrome.runtime.getURL("src/warning/index.html")}?url=${e.url}&resFlag=${e.resFlag}&time=${e.classifierTime}`):e.detectBy==="RealTime"&&location.assign(`${chrome.runtime.getURL("src/warning/index.html")}?url=${e.url}&resFlag=${e.resFlag}&classifierRes=${e.classifierRes}&classifierTime=${e.classifierTime}&copiedTime=${e.copiedTime}&ga=${e.ga}&copied=${e.copied}&script=${e.script}&extLink=${e.extLink}&noTitle=${e.noTitle}&samePageLink=${e.samePageLink}&iframe=${e.iframe}&tagCountInHead=${e.tagCountInHead}&noDomainInInternalLink=${e.noDomainInInternalLink}&invalidKiyaku=${e.invalidKiyaku}&ipAddressInLink=${e.ipAddressInLink}`)},F=async()=>document.documentElement.hasAttribute("data-scrapbook-source")||document.documentElement.outerHTML.includes("saved from url")||document.documentElement.outerHTML.includes("Page Saved with SingleFile")?1:0,q=async()=>{const e="https://www.google-analytics.com/analytics.js",s="https://www.googletagmanager.com/gtag/js",t=document.documentElement.outerHTML;return t.includes(e)||t.includes(s)?1:0},P=async()=>{let e=document.querySelectorAll("script").length;const s=document.querySelectorAll("iframe");for(const t of s)try{e+=t.contentWindow.document.querySelectorAll("script").length}catch{}return e},H=async()=>{const e=Array.from(document.querySelectorAll("a[href]")),s=document.querySelectorAll("iframe");for(const a of s)try{e.push(...a.contentWindow.document.querySelectorAll("a[href]"))}catch{}let t=0,o=0;for(const a of e){let n=a.getAttribute("href");if(!(n===""||n.startsWith("#")))if(n.startsWith("http")||n.startsWith("//")){n.startsWith("//")&&(n=`${location.protocol}${n}`);let i=new URL(n).hostname;for(;document.cookie=`pd_test_key=pd_test_value; domain=${i};`,i.indexOf(".")!==-1;)i=i.substring(i.indexOf(".")+1);for(document.cookie.includes("pd_test_key=pd_test_value")?o++:t++,i=new URL(n).hostname;document.cookie=`pd_test_key=pd_test_value; domain=${i}; max-age=0;`,i.indexOf(".")!==-1;)i=i.substring(i.indexOf(".")+1)}else o++}return t+o>0?t*100/(t+o):0},R=async()=>{let e=document.querySelector("title");return e===null||e.text===""?1:0},W=async()=>{const e=["","#","#nothing","#null","#void","#doesnotexist","#whatever"],s=[...document.querySelectorAll("a[href]")].map(a=>a.getAttribute("href")),t={};for(const a in s)e.includes(a.toLowerCase())||a.toLowerCase().startsWith("javascript")||(t[a]=(t[a]||0)+1);let o=0;for(const a of s)o<t[a]&&(o=t[a]);return o},O=async()=>document.querySelectorAll("iframe").length,B=async()=>document.querySelector("head").childElementCount,E=async()=>{const e=[...document.querySelectorAll("*[href]")].map(n=>n.getAttribute("href")),s=[...document.querySelectorAll("*[src]")].map(n=>n.getAttribute("src")),t=[...e,...s];let o=0,a=0;for(let n of t)if(n.startsWith("http")||n.startsWith("//")){n.startsWith("//")&&(n=`${location.protocol}${n}`);let i=new URL(n).hostname;for(;document.cookie=`pd_test_key=pd_test_value; domain=${i};`,i.indexOf(".")!==-1;)i=i.substring(i.indexOf(".")+1);for(document.cookie.includes("pd_test_key=pd_test_value")&&o++,i=new URL(n).hostname;document.cookie=`pd_test_key=pd_test_value; domain=${i}; max-age=0;`,i.indexOf(".")!==-1;)i=i.substring(i.indexOf(".")+1)}else o++,a++;return o>0?a/o:0},N=async()=>{const e=[...document.querySelectorAll("a")].filter(t=>t.text.includes("規約")||t.text.includes("プライバシーポリシー")),s=e.filter(t=>t.hasAttribute("href")).filter(t=>!t.getAttribute("href").startsWith("#"));return e.length===s.length?1:0},U=async()=>{const e=/^.*((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).*$/g,s=[...document.querySelectorAll("*[href]")].map(n=>n.getAttribute("href")),t=[...document.querySelectorAll("*[src]")].map(n=>n.getAttribute("src"));return[...s,...t].map(n=>e.test(n)).length>0?1:0},M=()=>{const e=document.documentElement,s={childList:!0,subtree:!0};new MutationObserver(o=>{o.forEach(a=>{a.addedNodes.forEach(n=>{n.nodeName.toLowerCase()==="input"&&f().then(async i=>{i.resFlag==="Phish"&&await $(i)})})})}).observe(e,s)};M();const D=setInterval(async()=>{f().then(async e=>{switch(e.resFlag){case"Phish":await $(e);break;case"_Phish":clearInterval(D);break}}).catch(e=>console.info(e))},500);
