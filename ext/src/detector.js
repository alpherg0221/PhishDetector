import{a as I,b as P,h as d,L as h}from"../assets/utils.js";chrome.runtime.onMessage.addListener((e,o,t)=>{switch(e.type){case"detection":return f().then(s=>t(s)),!0}});const f=async e=>{const o=await I(),t=await P(),s=await d(h.Allow),a=await d(h.Block),n=await d(h.Tmp).then(l=>l.map(u=>u.split("@")[0]));if(t&&s.includes(location.hostname))return{resFlag:"Safe",classifierRes:"Safe",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};if(o&&a.includes(location.hostname))return{resFlag:"Phish",classifierRes:"Phish",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};if(n.includes(location.hostname))return{resFlag:"_Phish",classifierRes:"_Phish",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};const i=6,g=performance.now()/1e3;let r="Safe",c="Safe";await v()||(c="NoPasswordForm",console.log("PhishDetector:NoPasswordForm"));const m=await F(),b=(performance.now()/1e3-g).toFixed(i),p=await C(),k=await q(),y=await H(),w=await R(),L=await W(),_=await D(),A=await N(),T=await O(),x=await B(),S=await E();if(c!=="NoPasswordForm"){console.log("PhishDetector : Start Detection");const l={copied:m,googleAnalytics:p,scriptTagCount:k,externalLinkPercentage:y,noTitle:w,samePageLink:L,iframeTagCount:_,tagCountInHeadTag:A,noDomainInInternalLink:T,invalidKiyaku:x,ipAddressInLink:S};console.log(l);const u=await chrome.runtime.sendMessage({type:"predict",features:l});console.log(`PhishDetector : Result : ${u}`),console.log("PhishDetector : Finish Detection"),u>=.5?r="Phish":r="Safe",m||r=="Phish"?c="Phish":c="Safe"}return{resFlag:c,classifierRes:r,url:location.hostname,copiedTime:b,classifierTime:(performance.now()/1e3-g).toFixed(i),detectBy:"RealTime",copied:m,ga:p,script:k,extLink:y,noTitle:w,samePageLink:L,iframe:_,tagCountInHead:A,noDomainInInternalLink:T,invalidKiyaku:x,ipAddressInLink:S}},v=async()=>{let e=document.querySelectorAll('input[type="password"]').length,o=document.querySelectorAll('input[type="text"]').length;const t=document.querySelectorAll("iframe");for(const s of t)try{e+=s.contentWindow.document.querySelectorAll('input[type="password"]').length,o+=s.contentWindow.document.querySelectorAll('input[type="text"]').length}catch{}return e>=1||o>=5},$=async e=>{e.detectBy==="List"?location.assign(`${chrome.runtime.getURL("src/warning/index.html")}?url=${e.url}&resFlag=${e.resFlag}&time=${e.classifierTime}`):e.detectBy==="RealTime"&&location.assign(`${chrome.runtime.getURL("src/warning/index.html")}?url=${e.url}&resFlag=${e.resFlag}&classifierRes=${e.classifierRes}&classifierTime=${e.classifierTime}&copiedTime=${e.copiedTime}&ga=${e.ga}&copied=${e.copied}&script=${e.script}&extLink=${e.extLink}&noTitle=${e.noTitle}&samePageLink=${e.samePageLink}&iframe=${e.iframe}&tagCountInHead=${e.tagCountInHead}&noDomainInInternalLink=${e.noDomainInInternalLink}&invalidKiyaku=${e.invalidKiyaku}&ipAddressInLink=${e.ipAddressInLink}`)},F=async()=>document.documentElement.hasAttribute("data-scrapbook-source")||document.documentElement.outerHTML.includes("saved from url")||document.documentElement.outerHTML.includes("Page Saved with SingleFile")?1:0,C=async()=>{const e="https://www.google-analytics.com/analytics.js",o="https://www.googletagmanager.com/gtag/js",t=document.documentElement.outerHTML;return t.includes(e)||t.includes(o)?1:0},q=async()=>{let e=document.querySelectorAll("script").length;const o=document.querySelectorAll("iframe");for(const t of o)try{e+=t.contentWindow.document.querySelectorAll("script").length}catch{}return e},H=async()=>{const e=Array.from(document.querySelectorAll("a[href]")),o=document.querySelectorAll("iframe");for(const a of o)try{e.push(...a.contentWindow.document.querySelectorAll("a[href]"))}catch{}let t=0,s=0;for(const a of e){let n=a.getAttribute("href");if(!(n===""||n.startsWith("#")))if(n.startsWith("http")||n.startsWith("//")){n.startsWith("//")&&(n=`${location.protocol}${n}`);let i=new URL(n).hostname;for(;document.cookie=`pd_test_key=pd_test_value; domain=${i};`,i.indexOf(".")!==-1;)i=i.substring(i.indexOf(".")+1);for(document.cookie.includes("pd_test_key=pd_test_value")?s++:t++,i=new URL(n).hostname;document.cookie=`pd_test_key=pd_test_value; domain=${i}; max-age=0;`,i.indexOf(".")!==-1;)i=i.substring(i.indexOf(".")+1)}else s++}return t+s>0?t*100/(t+s):0},R=async()=>{let e=document.querySelector("title");return e===null||e.text===""?1:0},W=async()=>{const e=["","#","#nothing","#null","#void","#doesnotexist","#whatever"],o=[...document.querySelectorAll("a[href]")].map(a=>a.getAttribute("href")),t={};for(const a in o)e.includes(a.toLowerCase())||a.toLowerCase().startsWith("javascript")||(t[a]=(t[a]||0)+1);let s=0;for(const a of o)s<t[a]&&(s=t[a]);return s},D=async()=>document.querySelectorAll("iframe").length,N=async()=>document.querySelector("head").childElementCount,O=async()=>{const e=[...document.querySelectorAll("*[href]")].map(n=>n.getAttribute("href")),o=[...document.querySelectorAll("*[src]")].map(n=>n.getAttribute("src")),t=[...e,...o];let s=0,a=0;for(let n of t)if(n.startsWith("http")||n.startsWith("//")){n.startsWith("//")&&(n=`${location.protocol}${n}`);let i=new URL(n).hostname;for(;document.cookie=`pd_test_key=pd_test_value; domain=${i};`,i.indexOf(".")!==-1;)i=i.substring(i.indexOf(".")+1);for(document.cookie.includes("pd_test_key=pd_test_value")&&s++,i=new URL(n).hostname;document.cookie=`pd_test_key=pd_test_value; domain=${i}; max-age=0;`,i.indexOf(".")!==-1;)i=i.substring(i.indexOf(".")+1)}else s++,a++;return s>0?a/s:0},B=async()=>{const e=[...document.querySelectorAll("a")].filter(t=>t.text.includes("規約")||t.text.includes("プライバシーポリシー")),o=e.filter(t=>t.hasAttribute("href")).filter(t=>!t.getAttribute("href").startsWith("#"));return e.length===o.length?1:0},E=async()=>{const e=/^.*((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).*$/g,o=[...document.querySelectorAll("*[href]")].map(n=>n.getAttribute("href")),t=[...document.querySelectorAll("*[src]")].map(n=>n.getAttribute("src"));return[...o,...t].map(n=>e.test(n)).length>0?1:0},U=()=>{const e=document.documentElement,o={childList:!0,subtree:!0};new MutationObserver(s=>{s.forEach(a=>{a.addedNodes.forEach(n=>{n.nodeName.toLowerCase()==="input"&&f().then(async i=>{i.resFlag==="Phish"&&await $(i)})})})}).observe(e,o)};U();const M=setInterval(async()=>{f().then(async e=>{switch(e.resFlag){case"Phish":await $(e);break;case"_Phish":clearInterval(M);break}}).catch(e=>console.info(e))},500);
