import{a as q,b as C,h as m,L as d}from"../assets/utils.js";chrome.runtime.onMessage.addListener((e,o,t)=>{switch(e.type){case"detection":return f().then(i=>t(i)),!0}});const f=async e=>{const o=await q(),t=await C(),i=await m(d.Allow),c=await m(d.Block),n=await m(d.Tmp).then(u=>u.map(b=>b.split("@")[0]));if(t&&i.includes(location.hostname))return{resFlag:"Safe",classifierRes:"Safe",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};if(o&&c.includes(location.hostname))return{resFlag:"Phish",classifierRes:"Phish",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};if(n.includes(location.hostname))return{resFlag:"_Phish",classifierRes:"_Phish",url:location.hostname,copiedTime:"0",classifierTime:"0",detectBy:"List"};const s=6,h=performance.now()/1e3;let a="Safe",r="Safe";await P()||(r="NoPasswordForm");const l=await F(),v=(performance.now()/1e3-h).toFixed(s),g=await I(),y=await H(),p=await W(),k=await R(),w=await O(),_=await B(),A=await E(),L=await N(),S=await $(),T=await M();if(r!=="NoPasswordForm"){const u={copied:l,googleAnalytics:g,scriptTagCount:y,externalLinkPercentage:p,noTitle:k,samePageLink:w,iframeTagCount:_,tagCountInHeadTag:A,noDomainInInternalLink:L,invalidKiyaku:S,ipAddressInLink:T};await chrome.runtime.sendMessage({type:"predict",features:u})>=.5?a="Phish":a="Safe",l||a=="Phish"?r="Phish":r="Safe"}return{resFlag:r,classifierRes:a,url:location.hostname,copiedTime:v,classifierTime:(performance.now()/1e3-h).toFixed(s),detectBy:"RealTime",copied:l,ga:g,script:y,extLink:p,noTitle:k,samePageLink:w,iframe:_,tagCountInHead:A,noDomainInInternalLink:L,invalidKiyaku:S,ipAddressInLink:T}},P=async()=>{let e=document.querySelectorAll('input[type="password"]').length,o=document.querySelectorAll('input[type="text"]').length;const t=document.querySelectorAll("iframe");for(const i of t)try{e+=i.contentWindow.document.querySelectorAll('input[type="password"]').length,o+=i.contentWindow.document.querySelectorAll('input[type="text"]').length}catch{}return e>=1||o>=5},x=async e=>{e.detectBy==="List"||e.detectBy},F=async()=>document.documentElement.hasAttribute("data-scrapbook-source")||document.documentElement.outerHTML.includes("saved from url")||document.documentElement.outerHTML.includes("Page Saved with SingleFile")?1:0,I=async()=>{const e="https://www.google-analytics.com/analytics.js",o="https://www.googletagmanager.com/gtag/js",t=document.documentElement.outerHTML;return t.includes(e)||t.includes(o)?1:0},H=async()=>{let e=document.querySelectorAll("script").length;const o=document.querySelectorAll("iframe");for(const t of o)try{e+=t.contentWindow.document.querySelectorAll("script").length}catch{}return e},W=async()=>{const e=Array.from(document.querySelectorAll("a[href]")),o=document.querySelectorAll("iframe");for(const c of o)try{e.push(...c.contentWindow.document.querySelectorAll("a[href]"))}catch{}let t=0,i=0;for(const c of e){let n=c.getAttribute("href");if(!(n===""||n.startsWith("#")))if(n.startsWith("http")||n.startsWith("//")){n.startsWith("//")&&(n=`${location.protocol}${n}`);let s=new URL(n).hostname;for(;document.cookie=`pd_test_key=pd_test_value; domain=${s};`,s.indexOf(".")!==-1;)s=s.substring(s.indexOf(".")+1);for(document.cookie.includes("pd_test_key=pd_test_value")?i++:t++,s=new URL(n).hostname;document.cookie=`pd_test_key=pd_test_value; domain=${s}; max-age=0;`,s.indexOf(".")!==-1;)s=s.substring(s.indexOf(".")+1)}else i++}return t+i>0?t*100/(t+i):0},R=async()=>{let e=document.querySelector("title");return e===null||e.text===""?1:0},O=async()=>{const e=["","#","#nothing","#null","#void","#doesnotexist","#whatever"],o=[...document.querySelectorAll("a[href]")].map(c=>c.getAttribute("href")),t={};for(const c in o)e.includes(c.toLowerCase())||c.toLowerCase().startsWith("javascript")||(t[c]=(t[c]||0)+1);let i=0;for(const c of o)i<t[c]&&(i=t[c]);return i},B=async()=>document.querySelectorAll("iframe").length,E=async()=>document.querySelector("head").childElementCount,N=async()=>{const e=[...document.querySelectorAll("*[href]")].map(n=>n.getAttribute("href")),o=[...document.querySelectorAll("*[src]")].map(n=>n.getAttribute("src")),t=[...e,...o];let i=0,c=0;for(let n of t)if(n.startsWith("http")||n.startsWith("//")){n.startsWith("//")&&(n=`${location.protocol}${n}`);let s=new URL(n).hostname;for(;document.cookie=`pd_test_key=pd_test_value; domain=${s};`,s.indexOf(".")!==-1;)s=s.substring(s.indexOf(".")+1);for(document.cookie.includes("pd_test_key=pd_test_value")&&i++,s=new URL(n).hostname;document.cookie=`pd_test_key=pd_test_value; domain=${s}; max-age=0;`,s.indexOf(".")!==-1;)s=s.substring(s.indexOf(".")+1)}else i++,c++;return i>0?c/i:0},$=async()=>{const e=[...document.querySelectorAll("a")].filter(t=>t.text.includes("規約")||t.text.includes("プライバシーポリシー")),o=e.filter(t=>t.hasAttribute("href")).filter(t=>!t.getAttribute("href").startsWith("#"));return e.length===o.length?1:0},M=async()=>{const e=/^.*((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9]).*$/g,o=[...document.querySelectorAll("*[href]")].map(n=>n.getAttribute("href")),t=[...document.querySelectorAll("*[src]")].map(n=>n.getAttribute("src"));return[...o,...t].map(n=>e.test(n)).length>0?1:0},U=()=>{const e=document.documentElement,o={childList:!0,subtree:!0};new MutationObserver(i=>{i.forEach(c=>{c.addedNodes.forEach(n=>{n.nodeName.toLowerCase()==="input"&&f().then(async s=>{s.resFlag==="Phish"&&await x(s)})})})}).observe(e,o)};U();const D=setInterval(async()=>{f().then(async e=>{switch(e.resFlag){case"Phish":await x(e);break;case"_Phish":clearInterval(D);break}}).catch(e=>console.info(e))},500);
